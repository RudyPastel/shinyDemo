---
title: "A first pass at the data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{firstPass}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

As the data basis of my app, I picked to the [Tidy
Tuesdays](https://www.tidytuesday.com/) `Wealth and income over time`
[repository](https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-02-09)
data set called `income_distribution.csv`. Before building the app, I need to know 
the data set and how best to represent it. As per the suggestion of the Tidy Tuesday
team, I will focus on enabling visual comparisons. For now, I will exclude statistical
analysis.

## Used packages

I will list here the packages used during the exploration. 
I will load them here for convenience but will no do so in the package code.

```{r}
library(magrittr)
library(ggplot2)
```



## Data dictionary and a first reflexion 

I decide to trust the Tidy Tuesday team and admit their data is clean.
`income_distribution.csv` is a cleaned version of the the raw data provided by
the [Urban Institute](https://apps.urban.org/features/wealth-inequality-charts/)
and the [US Census](https://www.census.gov/data/tables/time-series/demo/income-poverty/historical-income-households.html).
This file documents households by total money income, race, and 
hispanic origin of householder separated by year and income groups in USA.

|variable            |class     |description |
|:-------------------|:---------|:-----------|
|year                |integer   | Year |
|race                |character | Racial Group |
|number              |double    | Number of households |
|income_median       |integer   | Income median |
|income_med_moe      |integer   | Income median margin of error |
|income_mean         |integer   | Income mean |
|income_mean_moe     |integer   | Income mean margin of error |
|income_bracket      |character | Income bracket (9 total brackets between `<$15,000` and `>$200,000` |
|income_distribution |double    | Income distribution as the percentage of each year/racial group - should add up to 100 for a specific year and race. |

This definition suggests to compare quantities across races over the years. A
typical representation would be to display time series colour coded by race. In 
the case of income_distribution, one would have to represent the whole distribution
for each race fo each year, which may be overwhelming. 

Some variable definition considerations:

* Depending on the plot, one may have to consider the year variable a discrete or continuous.
* There may be some overlap between the races, the definition of which is already 
  questionable.
* The margin of error data may be irrelevant or uninformative to some viewers. 
  Maybe they should only be displayed optionally.

## Download then load the file

The file will be kept as a csv file within the package.

```{r}
filePath = system.file(package = 'shinyDemo', 'extdata', 'income_distribution.csv')
if (filePath == ""){#If there is no file, download it
  filePath = file.path(system.file(package = 'shinyDemo'), 'extdata', 'income_distribution.csv')
  utils::download.file(
    url ='https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/income_distribution.csv',
    destfile = filePath
  )
}
incomeDistribution <- readr::read_csv(file = filePath)
```
## A first look at the file

Let us start witht he first 100 rows to understand the structure of the file.

```{r}
head(x = incomeDistribution, n = 100)
```

For a give value of year, only the income_bracket and income_distribution columns
change. This structure may be useful for some statistical analysis but is not
directly suitable for visualisation. I will need to prepare the data before I
display it.

Let us continue with a file summary.

```{r}
summary(incomeDistribution)
```

There are two order of magnitudes between the minimal and the maximal value of number. 
I should enbale zooming. Besides, some columns have missing data. Why? 
Are the missing data randomly distributed?

```{r}
image(is.na(incomeDistribution))
```

There seems to be some structure in the NA distribution
 
```{r}
table(incomeDistribution$race)
```

The definition of the races is murky to me. Maybe the they are clear to the
US public. If I have time, I should like the presentation to the ad hoc definition.
Can I use this in the choice of colours?

```{r}
table(incomeDistribution$income_bracket)
```
 
The income bracket were read as characters but are ordered categories / factors.
   
   
   
   
Broken down by year and race, there are three measurements i.e. number,
income_median with income_med_moe and income_mean with income_mean_moe, and 
derivative quantities i.e. income_bracket and income_distribution. This suggests
to make five plots with the possibility to select which race is represented.


## number + year ~ race

Let us represent number of household by race of the years.

```{r}
# Take the columns you need and format them
numberVsYearByRace = incomeDistribution[, c('number', 'year', 'race')]
numberVsYearByRace = numberVsYearByRace[!duplicated(numberVsYearByRace), ]
summary(numberVsYearByRace)
```
What is the actual missing value?

```{r}
numberVsYearByRace[is.na(numberVsYearByRace$number), ]
```
Why is this value missing?

> Prior to being included in the "Asian" category in the 1980s, many Americans 
> of South Asian descent usually classified themselves as Caucasian or other.
>
> â€” [Wikipedia](https://en.wikipedia.org/wiki/Asian_Americans)

This should be a reminder that the definition fo these categories evolved over time.
Visual comparison of this data alone will be misleading. I should have some
warnings somewhere.

Let us plot now.

```{r}
rawPlot = ggplot(data = numberVsYearByRace, mapping = aes(x = year, y = number, colour = race)) +
  geom_line() + 
  labs(
    title = 'Number of household by racial group over the years in USA',
    x = 'Year',
    y = 'Number of households',
    colour = 'Racial Group'
  )
rawPlot
```

As expected, the range of the number of households is too large for convenient 
Inspection. Let us represent the race line independently.

```{r}
rawPlot + facet_grid(race ~ ., scales = 'free_y')
```

I need to display it conveniently for the users.


